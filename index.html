<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ATB — PECTAB → TT + DATA (single file)</title>
<style>
  :root{--bg:#0b0e12;--panel:#121720;--ink:#e6eefc;--muted:#9fb1ca;--brand:#5ea1ff;--ok:#7cffc2;--warn:#ffd66b}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0e1420;border-bottom:1px solid #1b2332}
  main{padding:14px;display:grid;gap:14px;grid-template-columns:380px 1fr}
  .card{background:#111725;border:1px solid #1b2332;border-radius:12px;overflow:hidden}
  .card .hd{padding:10px 12px;border-bottom:1px solid #1b2332;font-weight:600}
  .card .bd{padding:12px;display:grid;gap:10px}
  label{font-size:12px;color:var(--muted)}
  input[type=file],input[type=text],textarea,button,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243149;background:#0e131c;color:var(--ink)}
  textarea{min-height:120px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  button{cursor:pointer}
  .row{display:flex;gap:8px}
  .col2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .ok{color:var(--ok)} .muted{color:var(--muted)} .warn{color:var(--warn)}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .fine{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div><strong>ATB Converter</strong> <span class="muted">— PECTAB → Template + Data</span></div>
  <div class="fine">Target: ATB (boarding pass). ID defaults to <code>ATB0101</code>.</div>
</header>

<main>
  <section class="card">
    <div class="hd">1) Upload PECTAB (.txt) & Settings</div>
    <div class="bd">
      <input id="file" type="file" accept="text/plain,.txt" />
      <div class="col2">
        <div>
          <label>Template ID (ATB)</label>
          <input id="tplId" value="ATB0101" />
        </div>
        <div>
          <label>Data header</label>
          <input id="dataHeader" value="3CP" />
        </div>
      </div>
      <div class="row">
        <button id="btnConvert">Parse & Ask for Data</button>
        <button id="btnBuild">Build Outputs</button>
      </div>
      <div class="fine">Status: <span id="status" class="muted">waiting for file…</span></div>
    </div>
  </section>

  <!-- 2) Detected tokens -> inputs -->
  <section class="card" id="fieldsCard" hidden>
    <div class="hd">2) Fill field values (detected from <code>DATA=%…%</code>)</div>
    <div class="bd">
      <div id="fieldList"></div>
      <div class="row">
        <button id="btnApplyFields">Apply values</button>
        <button id="btnClearFields">Clear values</button>
      </div>
      <div class="fine">Detected tokens like <code>%NAME%</code>, <code>%FLIGHT%</code>. Enter values above.</div>
    </div>
  </section>

  <!-- 3) Outputs -->
  <section class="card">
    <div class="hd">Output — Template (TT)</div>
    <div class="bd">
      <textarea id="outTT" class="mono" placeholder="AD;TT03#01...#02...#" spellcheck="false"></textarea>
      <div class="row">
        <button id="btnCopyTT">Copy TT</button>
        <button id="btnDownloadTT">Download TT</button>
      </div>
      <div class="fine">Geometry/flags only. No data. Header uses <code>AD;TT03</code> by default.</div>
    </div>
  </section>

  <section class="card">
    <div class="hd">Output — Data (ATB)</div>
    <div class="bd">
      <textarea id="outData" class="mono" placeholder="3CP#05...#08...#...#$" spellcheck="false"></textarea>
      <div class="row">
        <button id="btnCopyData">Copy Data</button>
        <button id="btnDownloadData">Download Data</button>
      </div>
      <div class="fine">Values-only line. Starts with your Data header (e.g., <code>3CP</code>), ends with <code>#$</code>.</div>
    </div>
  </section>

  <section class="card">
    <div class="hd">Output — PECTAB (PT)</div>
    <div class="bd">
      <textarea id="outPT" class="mono" placeholder="AD;PT...#" spellcheck="false"></textarea>
      <div class="row">
        <button id="btnCopyPT">Copy PT</button>
        <button id="btnDownloadPT">Download PT</button>
      </div>
      <div class="fine">Monolithic program (placeholder packing). Often optional if you use TT+Data.</div>
    </div>
  </section>
</main>

<script>
// ---------- Minimal PECTAB (readable PT) parser ----------
const RE = {
  PT:   /^PT;ID=(.+)$/i,
  PAGE: /^PAGE;W=(\d+);H=(\d+)/i,
  TEXT: /^TEXT;X=(\d+);Y=(\d+);W=(\d+);H=(\d+);FONT=([^;]+);SIZE=(\d+);ALIGN=([^;]+);DATA=(.+)$/i,
  BAR:  /^BARCODE;TYPE=([^;]+);X=(\d+);Y=(\d+);W=(\d+);H=(\d+);MODULE=(\d+);DATA=(.+)$/i,
  BOX:  /^BOX;X=(\d+);Y=(\d+);W=(\d+);H=(\d+);T=(\d+)$/i
};

function parsePECTAB(txt){
  let id = 'ATB0101';
  let page = {w:0,h:0,dpi:203};
  const items = [];
  for(const raw of txt.split(/\r?\n/)){
    const line = raw.trim();
    if(!line || line.startsWith(';')) continue;
    let m;
    if(m = line.match(RE.PT)){ id = m[1]; continue; }
    if(m = line.match(RE.PAGE)){ page.w=+m[1]; page.h=+m[2]; continue; }
    if(m = line.match(RE.TEXT)){
      const [_,x,y,w,h,font,size,align,data]=m;
      items.push({kind:'text',x:+x,y:+y,w:+w,h:+h,font,size:+size,align,data});
      continue;
    }
    if(m = line.match(RE.BAR)){
      const [_,type,x,y,w,h,mod,data]=m;
      items.push({kind:'barcode',sym:type,x:+x,y:+y,w:+w,h:+h,module:+mod,data});
      continue;
    }
    if(m = line.match(RE.BOX)){
      const [_,x,y,w,h,t]=m;
      items.push({kind:'box',x:+x,y:+y,w:+w,h:+h,t:+t});
      continue;
    }
  }
  return {id,page,items};
}

// ---------- Placeholder packers (replace with KPM180H rules when available) ----------
let packers = {
  pad2: (n)=> (n<10?"0":"")+n,
  packCoords: (x,y,w,h)=> `${x.toString().padStart(4,'0')}${y.toString().padStart(4,'0')}${w.toString().padStart(4,'0')}${h.toString().padStart(4,'0')}`,
  packTextAttrs: (font,size,align)=> 'B0',   // 'B' block placeholder
  packBarcodeAttrs: (sym,module)=> ['B0',''],// same as text; placeholder
  packBoxAttrs: ()=> 'L0'                     // 'L' line/box placeholder
};

// ---------- Builders ----------
function buildTT(tpl, header='AD;TT03'){
  const parts = [header];
  let idx = 1;
  for(const it of tpl.items){
    const coords = packers.packCoords(it.x,it.y,it.w,it.h);
    if(it.kind==='box') parts.push(`#${packers.pad2(idx)}${packers.packBoxAttrs()}${coords}`);
    else parts.push(`#${packers.pad2(idx)}B0${coords}`);
    idx++;
  }
  return parts.join('');
}

function buildPT(tpl, header=`AD;PT`){
  const parts = [header];
  let idx = 1;
  for(const it of tpl.items){
    const coords = packers.packCoords(it.x,it.y,it.w,it.h);
    if(it.kind==='text') parts.push(`#${packers.pad2(idx)}T0${coords}`);
    else if(it.kind==='barcode') parts.push(`#${packers.pad2(idx)}K0${coords}`);
    else if(it.kind==='box') parts.push(`#${packers.pad2(idx)}G0${coords}`);
    idx++;
  }
  return parts.join('');
}

// Data builder (ATB values): sequential slots from item order (skip boxes)
function buildATBData(tpl, header='3CP'){
  const parts = [header];
  let idx = 1;
  for(const it of tpl.items){
    if(it.kind==='box'){ idx++; continue; }
    parts.push(`#${packers.pad2(idx)}${(it.data??'').toString()}`);
    idx++;
  }
  parts.push('#$');
  return parts.join('');
}

// Token detection and substitution
function detectTokens(tpl){
  const set = new Set();
  for(const it of tpl.items){
    const s = (it.data||'').toString().trim();
    if(/^%[^%]+%$/.test(s)) set.add(s.slice(1,-1));
  }
  return [...set];
}

function applyFieldValues(tpl, values){
  const clone = { id: tpl.id, page: tpl.page, items: tpl.items.map(it=>({...it})) };
  for(const it of clone.items){
    if(typeof it.data === 'string'){
      it.data = it.data.replace(/%([^%]+)%/g, (_,k)=> values[k] ?? '');
    }
  }
  return clone;
}

// ---------- UI wiring ----------
const fi = document.getElementById('file');
const tplIdEl = document.getElementById('tplId');
const dataHeaderEl = document.getElementById('dataHeader');
const statusEl = document.getElementById('status');
const btnConvert = document.getElementById('btnConvert');
const btnBuild = document.getElementById('btnBuild');

const fieldsCard = document.getElementById('fieldsCard');
const fieldList = document.getElementById('fieldList');
const btnApplyFields = document.getElementById('btnApplyFields');
const btnClearFields = document.getElementById('btnClearFields');

const outTT = document.getElementById('outTT');
const outData = document.getElementById('outData');
const outPT = document.getElementById('outPT');

const btnCopyTT = document.getElementById('btnCopyTT');
const btnDownloadTT = document.getElementById('btnDownloadTT');
const btnCopyData = document.getElementById('btnCopyData');
const btnDownloadData = document.getElementById('btnDownloadData');
const btnCopyPT = document.getElementById('btnCopyPT');
const btnDownloadPT = document.getElementById('btnDownloadPT');

let lastTpl = null;
let fieldValues = {}; // {TOKEN: value}

function renderFields(tokens){
  fieldsCard.hidden = tokens.length===0;
  fieldList.innerHTML = '';
  for(const name of tokens){
    const wrap = document.createElement('div');
    const lab = document.createElement('label');
    lab.textContent = `${name} =`;
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'mono';
    input.value = fieldValues[name] || '';
    input.placeholder = name;
    input.oninput = ()=> fieldValues[name] = input.value;
    wrap.appendChild(lab); wrap.appendChild(input);
    fieldList.appendChild(wrap);
  }
}

btnConvert.onclick = async ()=>{
  try{
    const f = fi.files && fi.files[0];
    if(!f){ statusEl.textContent = 'no file'; return; }
    const txt = await f.text();
    lastTpl = parsePECTAB(txt);
    // Override ID to user-specified ATB ID
    lastTpl.id = (tplIdEl.value||'ATB0101').trim();
    // detect tokens, prompt user once, also show inputs
    const tokens = detectTokens(lastTpl);
    renderFields(tokens);
    for(const t of tokens){
      const prev = fieldValues[t] || '';
      const v = prompt(`${t} =`, prev);
      if(v !== null) fieldValues[t] = v;
    }
    renderFields(tokens);
    statusEl.innerHTML = `<span class="ok">parsed</span> — ${lastTpl.items.length} elements · ${tokens.length} fields`;
  }catch(e){
    console.error(e);
    statusEl.innerHTML = `<span class="warn">error</span> (see console)`;
  }
};

btnApplyFields.onclick = ()=>{
  if(!lastTpl){ statusEl.textContent = 'load a file first'; return; }
  statusEl.textContent = 'values applied (ready to build)';
};

btnClearFields.onclick = ()=>{
  fieldValues = {};
  renderFields([]);
  outTT.value = outData.value = outPT.value = '';
  statusEl.textContent = 'cleared';
};

btnBuild.onclick = ()=>{
  if(!lastTpl){ statusEl.textContent = 'load a file first'; return; }
  // fill values and build outputs
  const filled = applyFieldValues(lastTpl, fieldValues);
  const tt = buildTT(filled, 'AD;TT03');
  const dataStr = buildATBData(filled, (dataHeaderEl.value||'3CP').trim());
  const pt = buildPT(filled, 'AD;PT');
  outTT.value = tt;
  outData.value = dataStr;
  outPT.value = pt;
  statusEl.innerHTML = `<span class="ok">built</span> — TT + DATA + PT ready`;
};

// copy + download helpers
function dl(text, name){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type:'text/plain'}));
  a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
btnCopyTT.onclick    = async ()=>{ if(outTT.value)   await navigator.clipboard.writeText(outTT.value); };
btnCopyData.onclick  = async ()=>{ if(outData.value) await navigator.clipboard.writeText(outData.value); };
btnCopyPT.onclick    = async ()=>{ if(outPT.value)   await navigator.clipboard.writeText(outPT.value); };
btnDownloadTT.onclick= ()=>{ if(outTT.value)   dl(outTT.value,'template-tt.txt'); };
btnDownloadData.onclick= ()=>{ if(outData.value) dl(outData.value,'data-atb.txt'); };
btnDownloadPT.onclick= ()=>{ if(outPT.value)   dl(outPT.value,'pectab-pt.txt'); };
</script>
</body>
</html>
